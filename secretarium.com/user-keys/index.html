<html>
    <head>
        <meta charset="utf-8">
        <script>
            (function(window) {

                var subscribers = {};

                window.onmessage = e => {
                    if (!window.parent || !e.data || !e.data.type)
                        return;
                    if (!/^https:\/\/(.*\.)?(secretarium|swisscom)\.(com|org|tech|ch|dev)\/?$/.test(e.origin))
                        return;

                    switch(e.data.type) {

                        case 'get': {
                                subscribers[e.origin] = true;
                                let keysJson = localStorage.getItem("user-keys");
                                if(!keysJson) keysJson = "[]";
                                window.parent.postMessage(keysJson, e.origin);
                            }
                            break;

                        case 'add': {
                                if(!e.data || !e.data.name || !e.data.version) return;
                                let key = JSON.stringify(e.data);
                                let keysJson = localStorage.getItem("user-keys");
                                if(!keysJson) {
                                    localStorage.setItem("user-keys", [key]);
                                }
                                else {
                                    let keys = JSON.parse(keysJson);
                                    let index = keys.findIndex(k => k.name == e.data.name && k.version == e.data.version);
                                    if(index != -1) {
                                        keys.splice(index, 1, key);
                                    }
                                    else {
                                        keys.push(key);
                                        keys.sort((a, b) => {
                                            return a.name == b.name
                                                ? (a.version == b.version ? 0 : a.version < b.version ? -1 : 1)
                                                : (a.name < b.name ? -1 : 1);
                                        });
                                    }
                                    localStorage.setItem("user-keys", JSON.stringify(keys));
                                }
                            }
                            break;

                        case 'remove': {
                                if(!e.data || !e.data.name || !e.data.version) return;
                                let keysJson = localStorage.getItem("user-keys");
                                if(keysJson) {
                                    let keys = JSON.parse(keysJson);
                                    let index = keys.findIndex(k => k.name == e.data.name && k.version == e.data.version);
                                    if(index != -1) {
                                        keys.splice(index, 1);
                                        localStorage.setItem("user-keys", JSON.stringify(keys));
                                    }
                                }
                            }
                            break;
                    }
                };

                window.onstorage = (e) => {
                    if(e.key != "user-keys") return;
                    if(Object.keys(subscribers).length == 0) return;
                    let keysJson = localStorage.getItem("user-keys");
                    if(!keysJson) keysJson = "[]";
                    for(let origin in subscribers) {
                        window.parent.postMessage(keysJson, origin);
                    }
                };

            })(window);
        </script>
    </head>
    <body></body>
</html>